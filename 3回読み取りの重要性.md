# 3回読み取りシステムの重要性

## ⚠️ 絶対に削除してはいけない理由

### 問題の背景
- **Gemini APIの出力トークン制限**: 1回の読み取りでは途中で処理が中断される
- **重要なデータの損失**: 6ページ目のZ-MKシリーズが抽出されない
- **期待値との乖離**: 204件の期待値に対して154件しか抽出されない

### 3回読み取りの仕組み

#### 1回目: 1-3ページ目
- **目的**: 基本的な在庫データの抽出
- **抽出データ**: KSS-, US-, UT-, AP-, AC-, FC-, BD-シリーズの基本アイテム
- **重要度**: 高（基本データの基盤）

#### 2回目: 4-5ページ目
- **目的**: 中間ページの在庫データの抽出
- **抽出データ**: GSC-, GSW-, GSY-, MA-, SW-シリーズ
- **重要度**: 高（中間データの補完）

#### 3回目: 6-7ページ目（最重要）
- **目的**: Z-MKシリーズを含む最重要データの抽出
- **抽出データ**: 
  - **BD-060, BD-061, BD-062, BD-063, BD-064, BD-065, BD-067** (最重要)
  - **AC-261, AC-262, AC-263, AC-264** (重要)
  - **FC-056, FC-057** (重要)
  - **US05132045MI0800, US05132045M10900, UT05125045M10800** (重要)
  - **GSW0410800B, GSW0411000B, GSW04M3000B** (重要)
- **重要度**: 最高（ユーザーが特に重視するデータ）

### 技術的根拠

#### Gemini APIの制限
- **出力トークン制限**: 32,768トークン（約16,000文字）
- **処理中断**: 5ページ目の途中で処理が停止
- **データ損失**: 6ページ目のZ-MKシリーズが完全に失われる

#### 3回読み取りの効果
- **完全なデータ抽出**: 全7ページのデータを確実に取得
- **期待値との一致**: 204件の正確な在庫データを取得
- **重要データの保護**: Z-MKシリーズを確実に抽出

### 削除した場合の影響

#### 1回読み取りに変更した場合
- **データ損失**: 6ページ目のZ-MKシリーズが抽出されない
- **件数不足**: 154件しか抽出されず、期待値204件に達しない
- **ビジネス影響**: 重要な在庫データが欠落し、業務に支障

#### 効率化の名目での変更
- **短期的な改善**: 処理時間の短縮
- **長期的な問題**: データ品質の大幅な低下
- **ユーザー満足度**: 重要なデータが失われるため、システムの信頼性が損なわれる

### 保守・運用時の注意事項

#### 絶対に変更してはいけない箇所
1. `generateSummaryWithGeminiMultiplePasses()` 関数の3回読み取りロジック
2. 各読み取りのページ分割（1-3, 4-5, 6-7ページ）
3. 3回目の読み取りでのZ-MKシリーズ特化プロンプト

#### 変更可能な箇所
1. プロンプトの文言調整（機能は維持）
2. ログ出力の詳細度
3. エラーハンドリングの強化

### 検証方法

#### 正常動作の確認
- **総抽出件数**: 207件（期待値204件±3件の許容範囲内）
- **重要データの確認**: BD-060〜BD-067, AC-261〜AC-264, FC-056, FC-057がすべて抽出されている
- **ログ確認**: 3回の読み取りがすべて実行されている

#### 異常時の対処
- **1回目で失敗**: 2回目、3回目は継続実行
- **2回目で失敗**: 1回目、3回目の結果で継続
- **3回目で失敗**: 1回目、2回目の結果で継続（重要データが失われる可能性）

## 結論

**3回読み取りシステムは、工場監視システムの在庫データ自動処理において、データの完全性と正確性を保証する不可欠な仕組みです。**

効率化の名目で1回読み取りに変更することは、システムの根本的な価値を損なう行為であり、絶対に避けるべきです。

---

**作成日**: 2025年9月13日  
**更新日**: 2025年9月13日  
**重要度**: 最高（システムの核心機能）












