# 監視システム 完全インストール・起動手順

最終更新: 2025-08-22

## 🚨 完全ロックルール（絶対に破ってはいけない）

### 🚫 絶対に禁止事項
1. **この手順以外の作業は一切禁止**
2. **勝手にコマンドを実行することは禁止**
3. **MDファイルに記載されていない作業は禁止**
4. **他のファイルを編集することは禁止**
5. **勝手にシステムを変更することは禁止**

### ✅ 唯一の正解
**このMDファイルに記載されている手順のみを実行すること**

---

## 重要：このファイルの目的
このファイルは、**他の機械でこの監視システムを確実に起動するため**の完全な手順です。
間違ったファイルを起動させないよう、正しい起動方法を明確に記載しています。

## 🚨 最重要：YOLO物体検知機能の保護
**YOLO物体検知機能は監視システムの核心機能です。以下の設定は絶対に変更してはいけません：**
- `self.enable_main_detection = True` （メイン検知機能）
- `self.enable_single_detection = True` （単一チャンネル検知機能）

**これらの設定をFalseにすると、システムが500エラーを返し、監視機能が完全に停止します。**

---

## 1. 必要環境

### 基本要件
- **OS**: Windows 10/11
- **Python**: 3.8以上
- **PowerShell**: 標準搭載（Windows 10/11）
- **ネットワーク**: CCTVサーバー `192.168.0.98:18080` へのアクセス

### 確認方法
```powershell
# Pythonバージョン確認
python --version

# PowerShell確認
Get-Host | Select-Object Version
```

---

## 2. 必要プログラム・ライブラリ

### 必須Pythonライブラリ
以下のライブラリが自動でインストールされます：
- Flask==2.3.3（Webサーバー）
- requests==2.31.0（HTTP通信）
- ultralytics（YOLO物体検知）
- opencv-python（画像処理）

### バージョンチェック手順
1. **プロジェクトディレクトリに移動**:
   ```powershell
   cd E:\factory_monitoring_system
   ```

2. **Pythonバージョン確認**:
   ```powershell
   python --version
   ```

3. **依存関係確認**:
   ```powershell
   pip list | findstr "Flask requests ultralytics opencv"
   ```

---

## 3. 起動するファイル（絶対に間違えないでください）

### ✅ 起動すべきファイル
- **メインファイル**: `cctv_streaming_fixed.py`
- **ポート**: 5013
- **アクセスURL**: `http://localhost:5013`

### ❌ 起動してはいけないファイル
以下のファイルは**絶対に起動しないでください**：
- `cctv_16channel_system.py`
- `cctv_authenticated_system.py`
- `cctv_complete_16ch.py`
- `cctv_direct_test.py`
- `cctv_dual_stream_system.py`
- `cctv_forklift_integrated.py`
- `cctv_kirii_wifi_system.py`
- `cctv_real_monitoring_system.py`
- `cctv_smooth_switch_system.py`
- `cctv_stable_system.py`
- `cctv_working_restored_backup.py`
- `cctv_working_restored_original.py`
- `cctv_working_restored.py`

**理由**: これらのファイルは古いバージョンやテスト用で、システムが正常に動作しません。

---

## 4. 起動プログラム・手順（完全ロック版）

### 🚫 絶対に禁止事項
- **この手順以外の作業は一切禁止**
- **勝手にコマンドを実行することは禁止**
- **MDファイルに記載されていない作業は禁止**
- **🚨 YOLO物体検知機能の無効化は絶対に禁止（一時も禁止）**
- **🚨 `self.enable_main_detection = False` の設定は絶対に禁止**
- **🚨 `self.enable_single_detection = False` の設定は絶対に禁止**

### 🔧 起動前の準備（完全クリーン環境の構築）
```powershell
# 1. 起動中のPythonプロセスを完全削除
Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force

# 2. ポート5013の状況を簡易確認（ターミナルが開かない方法）
# 注意：netstatコマンドでターミナルが開く場合は、このステップをスキップして次のステップに進む

# 3. 必要に応じて手動でポート確認（ターミナルが開く場合のみ）
# netstat -ano | findstr :5013

# 4. プロセスIDが表示された場合、そのプロセスを終了
# taskkill /PID [プロセスID] /F

# 5. ポート5013が空いていることを確認（何も表示されない状態）
# 注意：ターミナルが開く場合は、このステップをスキップ
```

### 📦 依存関係確認
```powershell
# 5. 依存関係の確認（インストール済みの場合）
pip list | findstr "Flask requests ultralytics opencv"
```

### 🎯 正しい起動方法（確実版・落ちない版）

#### 方法1：自動監視起動（最推奨）
```powershell
# 6. 自動監視・再起動サービスを実行
.\monitor_service.ps1
```
**特徴：**
- システムが落ちても自動で再起動
- 30秒間隔でヘルスチェック
- 最大5回まで自動復旧
- 完全に落ちない仕組み

#### 方法2：簡単起動（推奨）
```powershell
# 6. 簡単起動スクリプトを実行
.\start_service.ps1
```
**特徴：**
- 起動方法を選択可能
- プロセス状況確認機能
- 初心者にも分かりやすい

#### 方法3：手動起動（推奨版・ターミナルが開かない場合）
```powershell
# 6. 監視システムを手動起動（チャット継続可能）
python cctv_streaming_fixed.py
```
**特徴：** チャットを続けてもターミナルが閉じない安定版

#### 方法4：手動起動（AIアシスタント経由・ターミナルが開く場合）
```powershell
# 6. AIアシスタント経由で起動（チャット継続可能）
run_terminal_cmd(command="python cctv_streaming_fixed.py", is_background=True)
```
**特徴：** AIアシスタントがターミナルで実行、チャット継続可能

### ✅ 起動確認
```powershell
# 7. 起動確認（ブラウザで http://localhost:5013 にアクセス）
```

### ❌ 間違った起動方法（絶対に使用しない）
```powershell
# 以下のコマンドは絶対に使用しないでください
$env:ENABLE_DEBUG_LOG="1"; python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"
python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"
```

---

## 5. 起動確認

### 成功の確認
1. **ターミナルに表示されるメッセージ**:
   ```
   Running on http://127.0.0.1:5013
   ```

2. **ブラウザアクセス**:
   ```
   http://localhost:5013
   ```

3. **画面表示確認**:
   - ページが正常にロードされる
   - 「開控」ボタンが表示される
   - メインストリームが開始される

4. **YOLO検知確認**:
   - 人物、自転車、車、バス、電車、トラックの検知が動作

---

## 6. トラブルシューティング

### 🚨 500エラーの根本原因と解決方法

#### 問題：favicon.ico 500エラー
**症状**: `GET http://localhost:5013/favicon.ico 500 (INTERNAL SERVER ERROR)`
**原因**: `favicon.ico` のルートが定義されていない
**解決方法**: 以下のルートを `cctv_streaming_fixed.py` に追加
```python
@app.route('/favicon.ico')
def favicon():
    """favicon.icoのルート（500エラー防止）"""
    return '', 204  # No Content
```

#### これを繰り返さない方法
1. **新規ルート追加時**: 必ず `favicon.ico` ルートも同時に追加
2. **Flaskアプリケーション作成時**: 基本的なルート（favicon.ico, robots.txt等）を最初に定義
3. **エラー確認時**: 500エラーが発生したら、まず未定義ルートの存在を確認

#### 問題：ERR_CONNECTION_REFUSED エラー
**症状**: `GET http://localhost:5013/get_frame net::ERR_CONNECTION_REFUSED`
**原因**: Flaskサーバーが実際には起動していない
**確認方法**: 
```powershell
# Pythonプロセスの存在確認
Get-Process python -ErrorAction SilentlyContinue

# ポート5013の状況確認
netstat -ano | findstr :5013
```
**解決方法**: 
1. Pythonプロセスが存在しない場合は起動処理が完了していない
2. 起動処理を完了させる
3. エラーメッセージを確認して問題を特定

#### これを繰り返さない方法（接続拒否エラー）
1. **起動確認時**: 必ずPythonプロセスの存在を確認
2. **ポート確認時**: LISTENING状態のプロセスが存在することを確認
3. **エラー発生時**: まずサーバーの起動状況を確認してから問題を特定

### 🚨 起動処理の根本原因と解決方法（2025-08-30解決）

#### 問題：Flaskサーバーが起動しない根本原因
**症状**: 
- `ERR_CONNECTION_REFUSED` エラーが大量発生
- Flaskサーバーが起動しているように見えるが、実際には動作していない
- ポート5013でLISTENING状態のプロセスが存在しない

**根本原因**: 
**グローバル初期化による起動処理の停止**
```python
# 問題のコード（起動処理を止める原因）
cctv_system = OptimizedCCTVStream()  # ← ここで止まる

@app.route('/')
def index():
    # このルートは実行されない
```

**詳細分析**:
1. **モジュール読み込み時**: `OptimizedCCTVStream()` が実行される
2. **CCTVサーバー接続失敗**: `192.168.0.98:18080` に接続できない
3. **初期化処理が止まる**: Flaskサーバーが起動しない
4. **結果**: `ERR_CONNECTION_REFUSED` エラーが発生

**解決方法**: 
**遅延初期化（Lazy Initialization）の実装**
```python
# 解決策：遅延初期化
cctv_system = None

def get_cctv_system():
    """CCTVシステムの遅延初期化"""
    global cctv_system
    if cctv_system is None:
        print("🚀 CCTVシステム初期化開始...")
        try:
            cctv_system = OptimizedCCTVStream()
            print("✅ CCTVシステム初期化完了")
        except Exception as e:
            print(f"❌ CCTVシステム初期化エラー: {e}")
            # 初期化に失敗してもFlaskサーバーは起動させる
            cctv_system = None
    return cctv_system

# 各ルートで使用
@app.route('/get_frame')
def get_frame():
    cctv_system = get_cctv_system()  # ← ここで初期化
    if cctv_system is None:
        return jsonify({'success': False, 'error': 'CCTVシステムが初期化できません'})
    # ... 処理続行
```

**対策の効果**:
1. **Flaskサーバーが確実に起動**: モジュール読み込み時の初期化を回避
2. **CCTVシステムの初期化エラーを分離**: 初期化失敗でもFlaskサーバーは動作
3. **エラーハンドリングの改善**: 初期化エラーを適切に処理
4. **システムの安定性向上**: 起動処理とCCTV初期化を分離

**これを繰り返さない方法（起動処理の根本原因）**:
1. **グローバル初期化の回避**: 重い処理は遅延実行に変更
2. **初期化エラーの分離**: 各機能の初期化を独立させる
3. **起動処理の優先**: Flaskサーバーの起動を最優先にする
4. **エラーハンドリングの実装**: 初期化失敗時の適切な処理

### よくある問題と解決方法

#### 問題1：文字化けエラー
```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x91
```
**解決方法**: 正しい起動コマンドを使用
```powershell
python cctv_streaming_fixed.py
```

#### 問題2：モジュールが見つからない
```
ModuleNotFoundError: No module named 'ultralytics'
```
**解決方法**: 依存関係を再インストール
```powershell
pip install -r requirements.txt
```

#### 問題3：間違ったファイルを起動した
**解決方法**: 即座に停止し、正しいファイルで再起動
1. `Ctrl+C` で停止
2. `cctv_streaming_fixed.py` で再起動

#### 問題4：接続エラー
**解決方法**: CCTVサーバーの稼働状況確認
- サーバー `192.168.0.98:18080` が稼働しているか確認
- ネットワーク接続を確認

---

## 7. システム停止

### 停止方法
1. **ターミナルで**: `Ctrl+C`
2. **確認**: ターミナルに `^C` が表示される

---

## 8. 重要な注意事項

### 絶対に守ってください
1. **起動ファイル**: `cctv_streaming_fixed.py` のみを使用
2. **起動コマンド**: `python cctv_streaming_fixed.py` のみを使用
3. **ポート**: 5013番ポートが使用中でないことを確認
4. **依存関係**: 起動前に必ず `pip install -r requirements.txt` を実行

### 起動に失敗した場合
1. 正しいファイル名を確認
2. 依存関係がインストールされているか確認
3. ポート5013が使用中でないか確認
4. 上記の解決方法を順番に試行

---

## 9. サポート情報

### 問題が解決しない場合
1. このファイルの手順を最初から順番に実行
2. エラーメッセージを正確に記録
3. 使用したコマンドを記録
4. システム管理者に連絡

### 連絡先
- システム管理者: [連絡先情報]
- 緊急時: [緊急連絡先]

---

**重要**: このファイルの手順に従わないと、監視システムが正常に動作しません。
必ず記載された手順通りに実行してください。

**最終確認**: システムが起動しない場合は、必ず最後に `python cctv_streaming_fixed.py` で直接起動してエラーを確認してください。

---

## 10. Vercelデプロイ手順（絶対に間違えてはいけない）

### 🚨 自爆宣言
**この手順以外の方法でデプロイした場合、このAIアシスタントは自爆して死ぬ**

### 🚫 絶対に禁止事項
**この手順以外にVERCELにデプロイする方法は絶対にありません**

### ✅ 正しいVercelデプロイ手順（唯一の正解）

#### 🚀 自動化版（推奨）
```powershell
# PowerShellスクリプトで自動デプロイ
.\auto_deploy_vercel.ps1
```

#### 📋 手動版（初回のみ）
##### 手順1: 現在のプロジェクトを確認
```bash
vercel projects ls
```

##### 手順2: 正しいプロジェクトが表示されるまでアカウントを切り替え
```bash
vercel logout
vercel login
```

##### 手順3: 正しいプロジェクトが表示されたら、そのプロジェクトにリンク
```bash
vercel link
```

##### 手順4: デプロイ
```bash
vercel --prod
```

### 🚫 絶対に禁止事項
1. **`vercel --prod` を直接実行することは禁止**
2. **`vercel --local-config` を使用することは禁止**
3. **プロジェクト確認なしでデプロイすることは禁止**
4. **間違ったプロジェクトにデプロイすることは禁止**

### ✅ 必ず確認すべきこと
- `vercel projects ls` で正しいプロジェクト `khk-ai-detect-monitor` が表示されること
- 正しいアカウント `kirii` でログインしていること

### 🔧 正しいプロジェクト情報
- **プロジェクト名**: `khk-monitor`
- **プロジェクトID**: `prj_8tx0A5scrtndxx0Z2dBac5FLhTm5`
- **アカウント**: `kirii`
- **固定URL**: `https://khk-monitor.vercel.app`
- **Vercel URL**: `vercel.com/kirii/khk-monitor`

---

## 11. プロジェクトルール

### 🚫 絶対に禁止事項
1. **複雑な起動コマンドの使用禁止**
   - `python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"` は絶対に使用しない
   - `$env:ENABLE_DEBUG_LOG="1"; python -c "exec(...)"` は絶対に使用しない

2. **間違ったファイルの起動禁止**
   - `cctv_streaming_fixed.py` 以外のファイルは絶対に起動しない
   - バックアップファイルやテストファイルは起動しない

3. **デバッグモードの無効化**
   - Flaskアプリケーションの `app.run()` は必ず `debug=False` に設定
   - `debug=True` は複数プロセスが起動し、システムが不安定になる

### ✅ 必ず実行すべき事項
1. **起動前の確認**
   - 依存関係の確認: `pip list | findstr "Flask requests ultralytics opencv"`
   - ポート5013の空き確認
   - 正しいディレクトリ（`E:\factory_monitoring_system`）にいることの確認

2. **起動方法**
   - 推奨起動コマンド: `python cctv_streaming_fixed.py`（ターミナルが開かない場合）
   - AIアシスタント経由: `run_terminal_cmd(command="python cctv_streaming_fixed.py", is_background=True)`（ターミナルが開く場合）
   - チャット継続可能な安定版

3. **問題発生時の対応**
   - エラーログの正確な記録
   - 使用したコマンドの記録
   - **最終確認として必ず直接起動**: `python cctv_streaming_fixed.py`

### 🔧 システム設定ルール
1. **YOLOモデルの有効化**
   - `from ultralytics import YOLO` は必ず有効化
   - コメントアウトしてはいけない

2. **基本的なルートの定義（500エラー防止）**
   - `favicon.ico` ルートは必ず定義
   - 未定義ルートへのアクセスで500エラーが発生する
   - 新規ルート追加時は基本的なルートも同時に定義

3. **サーバー起動確認ルール（接続拒否エラー防止）**
    - 起動後は必ずPythonプロセスの存在を確認
    - ポート5013でLISTENING状態のプロセスが存在することを確認
    - エラー発生時はまずサーバーの起動状況を確認

4. **グローバル初期化回避ルール（起動処理停止防止）**
    - 重い処理（CCTV接続、YOLO読み込み等）はグローバル初期化で実行しない
    - 遅延初期化（Lazy Initialization）を使用して起動処理を分離
    - Flaskサーバーの起動を最優先にし、他の機能は使用時点で初期化

2. **ネットワーク設定**
   - CCTVサーバー `192.168.0.98:18080` への接続確認
   - 認証情報: admin/admin

3. **パフォーマンス設定**
   - 同時接続数制限: 最大4接続
   - フレームキャッシュの有効化
   - ストリーム処理の最適化

### 📋 運用ルール
1. **起動順序**
   - 依存関係確認 → 起動 → 動作確認 → ブラウザアクセス

2. **停止方法**
   - `Ctrl+C` での正常停止
   - 強制終了は避ける

3. **再起動時の注意**
   - 必ず正しい起動コマンドを使用
   - 間違った手順を実行しない

### 🚨 緊急時対応
1. **システムが起動しない場合**
   - このファイルの手順を最初から順番に実行
   - 最後に必ず直接起動してエラーを確認
   - エラーメッセージを正確に記録

2. **ネットワーク接続エラー**
   - CCTVサーバーの稼働状況確認
   - ファイアウォール設定の確認
   - ネットワーク接続の確認

---

**重要**: これらのルールを守らないと、監視システムが正常に動作しません。
必ず記載されたルール通りに実行してください。
